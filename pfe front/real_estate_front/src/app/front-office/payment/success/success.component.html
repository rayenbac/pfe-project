<div class="success-page-container">
  <div class="container">
    <!-- Loading State -->
    <div class="row justify-content-center" *ngIf="loading">
      <div class="col-md-6 text-center">
        <div class="loading-card">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="sr-only">Loading...</span>
          </div>
          <h4>Confirming your reservation...</h4>
          <p class="text-muted">Please wait while we process your payment</p>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div class="row justify-content-center" *ngIf="error && !loading">
      <div class="col-md-8">
        <div class="error-card text-center">
          <div class="error-icon mb-3">
            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          </div>
          <h2 class="text-danger mb-3">Reservation Error</h2>
          <p class="mb-4">{{ error }}</p>
          <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-primary" (click)="router.navigate(['/properties'])">
              <i class="fas fa-search"></i> Browse Properties
            </button>
            <button class="btn btn-outline-secondary" (click)="router.navigate(['/contact'])">
              <i class="fas fa-envelope"></i> Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Success State -->
    <div class="row justify-content-center" *ngIf="!loading && !error && paymentDetails">
      <div class="col-lg-10">
        
        <!-- Success Header -->
        <div class="success-header text-center mb-5">
          <div class="success-icon mb-3">
            <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
          </div>
          <h1 class="text-success mb-2">Reservation Confirmed!</h1>
          <p class="lead text-muted">Your booking has been successfully confirmed and payment processed.</p>
        </div>

        <!-- Reservation Summary Card -->
        <div class="reservation-summary-card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
              <i class="fas fa-calendar-check text-primary me-2"></i>
              Reservation Details
            </h3>
            <button class="btn btn-outline-primary btn-sm" (click)="printReservation()">
              <i class="fas fa-print me-1"></i> Print Confirmation
            </button>
          </div>
          
          <div class="card-body" id="reservation-details">
            <!-- Property Information -->
            <div class="property-info mb-4">
              <div class="row">
                <div class="col-md-8">
                  <h4 class="property-title">
                    <i class="fas fa-home text-primary me-2"></i>
                    {{ paymentDetails.propertyTitle || paymentDetails.propertyId?.title || 'Property Booking' }}
                  </h4>
                  <p class="text-muted mb-0" *ngIf="paymentDetails.propertyId?.address">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    {{ paymentDetails.propertyId.address?.street }}, {{ paymentDetails.propertyId.address?.city }}
                  </p>
                </div>
                <div class="col-md-4 text-md-end">
                  <div class="total-amount">
                    <span class="amount-label">Total Paid</span>
                    <div class="amount-value">
                      {{ paymentDetails.currency.toUpperCase() }} {{ paymentDetails.amount | number:'1.2-2' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Booking Details -->
            <div class="booking-details" *ngIf="paymentDetails.bookingDetails || paymentDetails.reservationData">
              <div class="row">
                <div class="col-md-6">
                  <div class="detail-group">
                    <h5 class="detail-title">
                      <i class="fas fa-calendar-alt text-primary me-2"></i>
                      Stay Dates
                    </h5>
                    <div class="detail-item">
                      <strong>Check-in:</strong>
                      <span>{{ (paymentDetails.bookingDetails?.startDate || paymentDetails.reservationData?.startDate) | date:'fullDate' }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Check-out:</strong>
                      <span>{{ (paymentDetails.bookingDetails?.endDate || paymentDetails.reservationData?.endDate) | date:'fullDate' }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Duration:</strong>
                      <span>{{ paymentDetails.bookingDetails?.metadata?.rentalDays || calculateNights() }} nights</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="detail-group">
                    <h5 class="detail-title">
                      <i class="fas fa-users text-primary me-2"></i>
                      Guest Information
                    </h5>
                    <div class="detail-item">
                      <strong>Guest Name:</strong>
                      <span>{{ (paymentDetails.bookingDetails?.contactInfo?.firstName || paymentDetails.reservationData?.firstName) }} {{ (paymentDetails.bookingDetails?.contactInfo?.lastName || paymentDetails.reservationData?.lastName) }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Number of Guests:</strong>
                      <span>{{ paymentDetails.bookingDetails?.guestCount || paymentDetails.reservationData?.guestCount }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Email:</strong>
                      <span>{{ paymentDetails.bookingDetails?.contactInfo?.email || paymentDetails.reservationData?.email }}</span>
                    </div>
                    <div class="detail-item" *ngIf="paymentDetails.bookingDetails?.contactInfo?.phone || paymentDetails.reservationData?.phone">
                      <strong>Phone:</strong>
                      <span>{{ paymentDetails.bookingDetails?.contactInfo?.phone || paymentDetails.reservationData?.phone }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Special Requests -->
              <div class="row mt-3" *ngIf="paymentDetails.bookingDetails?.specialRequests || paymentDetails.reservationData?.specialRequests">
                <div class="col-12">
                  <div class="detail-group">
                    <h5 class="detail-title">
                      <i class="fas fa-comment text-primary me-2"></i>
                      Special Requests
                    </h5>
                    <div class="special-requests-text">
                      {{ paymentDetails.bookingDetails?.specialRequests || paymentDetails.reservationData?.specialRequests }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Information -->
            <div class="payment-info mt-4">
              <h5 class="detail-title">
                <i class="fas fa-credit-card text-primary me-2"></i>
                Payment Information
              </h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="detail-item">
                    <strong>Confirmation Number:</strong>
                    <span class="confirmation-number">{{ paymentDetails.stripePaymentIntentId || paymentDetails.konnectPaymentId }}</span>
                  </div>
                  <div class="detail-item">
                    <strong>Payment Method:</strong>
                    <span>{{ paymentDetails.konnectPaymentId ? 'Konnect (TND)' : 'Credit Card (USD)' }}</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="detail-item">
                    <strong>Payment Status:</strong>
                    <span class="badge badge-success">Paid</span>
                  </div>
                  <div class="detail-item">
                    <strong>Payment Date:</strong>
                    <span>{{ (paymentDetails.createdAt || paymentDetails.paymentDate) | date:'medium' }}</span>
                  </div>
                </div>
              </div>
              
              <!-- Currency Details for Konnect payments -->
              <div class="currency-details mt-3" *ngIf="paymentDetails.konnectPaymentId && paymentDetails.bookingDetails?.metadata">
                <div class="card border-primary">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      <i class="fas fa-exchange-alt me-2"></i>Payment Details
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="amount-info">
                          <label class="text-muted small">Original Amount (Property Currency)</label>
                          <div class="h6 mb-0">
                            {{ paymentDetails.bookingDetails.metadata.originalCurrency || 'USD' }} 
                            {{ paymentDetails.bookingDetails.metadata.originalAmount | number:'1.2-2' }}
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="amount-info">
                          <label class="text-muted small">Amount Paid (Konnect)</label>
                          <div class="h6 mb-0 text-success">
                            TND {{ paymentDetails.amount | number:'1.2-2' }}
                          </div>
                          <small class="text-muted" *ngIf="paymentDetails.bookingDetails?.metadata?.exchangeRate">
                            Exchange Rate: 1 USD = {{ paymentDetails.bookingDetails.metadata.exchangeRate | number:'1.2-2' }} TND
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pricing Breakdown -->
            <div class="pricing-breakdown mt-4" *ngIf="paymentDetails.bookingDetails">
              <h5 class="detail-title">
                <i class="fas fa-calculator text-primary me-2"></i>
                Pricing Breakdown
              </h5>
              <div class="pricing-table">
                <div class="pricing-row">
                  <span>Base Rate ({{ paymentDetails.bookingDetails.metadata?.rentalDays || calculateNights() }} nights × {{ (paymentDetails.bookingDetails.metadata?.pricePerDay | number:'1.2-2') || 'N/A' }}):</span>
                  <span>{{ paymentDetails.currency.toUpperCase() }} {{ ((paymentDetails.bookingDetails.metadata?.pricePerDay || 0) * (paymentDetails.bookingDetails.metadata?.rentalDays || 1)) | number:'1.2-2' }}</span>
                </div>
                <div class="pricing-row" *ngIf="paymentDetails.bookingDetails.extraGuestSurcharge > 0">
                  <span>Extra Guest Surcharge:</span>
                  <span>{{ paymentDetails.currency.toUpperCase() }} {{ paymentDetails.bookingDetails.extraGuestSurcharge | number:'1.2-2' }}</span>
                </div>
                <div class="pricing-row total-row">
                  <span><strong>Total Amount:</strong></span>
                  <span><strong>{{ paymentDetails.currency.toUpperCase() }} {{ paymentDetails.amount | number:'1.2-2' }}</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons text-center">
          <div class="d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-primary btn-lg" (click)="viewProperty()">
              <i class="fas fa-eye me-2"></i>
              View Property
            </button>
            <button class="btn btn-outline-primary btn-lg" (click)="viewReservations()">
              <i class="fas fa-list me-2"></i>
              My Reservations
            </button>
            <button class="btn btn-outline-secondary btn-lg" (click)="router.navigate(['/properties'])">
              <i class="fas fa-search me-2"></i>
              Browse More Properties
            </button>
          </div>
        </div>

        <!-- Confirmation Notice -->
        <div class="confirmation-notice mt-5 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>What's Next?</strong> A confirmation email has been sent to your email address. 
            Please save this confirmation for your records. If you have any questions, feel free to contact our support team.
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
